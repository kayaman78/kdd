# KDD Setup Guide

Quick setup guide for configuring KDD on your servers.

---

## Prerequisites

- Komodo instance with server(s) connected
- Docker installed on target server(s)
- Running database containers (MySQL/MariaDB, PostgreSQL, MongoDB)

---

## Setup Process (5 minutes per server)

### 1. Open Komodo Shell

Komodo → **Servers** → Select your server → **Shell**

### 2. Run Setup Command

**Standard path (`/srv/docker`):**

```bash
mkdir -p /srv/docker/kdd/{config,dump} && \
cd /srv/docker/kdd && \
docker run --rm -it \
  -v /var/run/docker.sock:/var/run/docker.sock:ro \
  -v $(pwd)/config:/config \
  ghcr.io/kayaman78/kdd:latest /app/setup.sh --interactive
```

**Custom path (e.g., `/opt/containers`):**

```bash
mkdir -p /opt/containers/kdd/{config,dump} && \
cd /opt/containers/kdd && \
docker run --rm -it \
  -v /var/run/docker.sock:/var/run/docker.sock:ro \
  -v $(pwd)/config:/config \
  ghcr.io/kayaman78/kdd:latest /app/setup.sh --interactive
```

### 3. Interactive Database Selection

The setup script will scan your Docker containers and prompt for each database:

```
Found MySQL/MariaDB: nextcloud_db_1 (mariadb:10.11)
  Database: nextcloud (user: root)
  Add nextcloud_db_1 to backup config? [y/N] y
  Added to config: nextcloud

Found PostgreSQL: gitea_db_1 (postgres:16)
  Database: gitea (user: gitea)
  Add gitea_db_1 to backup config? [y/N] y
  Added to config: gitea

Found PostgreSQL: immich_db_1 (postgres:16)
  Database: immich (user: immich)
  Add immich_db_1 to backup config? [y/N] n
  Skipped by user
```

**Tips:**
- Answer `y` to include database in backups
- Answer `n` to skip (e.g., databases with their own backup solution like Immich)
- Press Enter (default: `n`) to skip

### 4. Verify Configuration

```bash
# View generated config
cat config/config.yaml
```

**Example output:**
```yaml
# Auto-generated by KDD setup.sh - 2025-02-11 15:30:00
mysql:
  - name: nextcloud
    host: nextcloud_db_1
    dbname: nextcloud
    user: root
    password: secretpass123
    network: mynetwork

postgres:
  - name: gitea
    host: gitea_db_1
    dbname: gitea
    user: gitea
    password: giteapass
    network: mynetwork

mongo: []
```

### 5. Edit Configuration (Optional)

If you need to modify the config:

```bash
nano config/config.yaml
```

**Common edits:**
- Remove databases you don't want to backup
- Fix incorrect credentials
- Change database names

### 6. Test Configuration

```bash
# List what was found
cat config/config.yaml | grep "name:"
```

---

## Multi-Server Setup

Repeat steps 1-5 for each server you want to backup.

Each server will have its own config file at:
- Server 1: `/srv/docker/kdd/config/config.yaml`
- Server 2: `/srv/docker/kdd/config/config.yaml`
- etc.

---

## Directory Structure

After setup, you'll have:

```
/srv/docker/kdd/
├── config/
│   └── config.yaml          # Generated configuration
└── dump/                     # Backup storage (empty until first backup)
```

---

## Troubleshooting

### No databases found

**Problem:** Setup completes but shows 0 databases.

**Solutions:**
- Verify containers are running: `docker ps`
- Check container environment variables contain DB credentials
- Try non-interactive mode to see all containers: 
  ```bash
  docker run --rm \
    -v /var/run/docker.sock:/var/run/docker.sock:ro \
    -v $(pwd)/config:/config \
    ghcr.io/kayaman78/kdd:latest /app/setup.sh
  ```

### Permission denied on Docker socket

**Problem:** `permission denied while trying to connect to the Docker daemon socket`

**Solution:** User needs Docker socket access. Run:
```bash
sudo usermod -aG docker $USER
# Then logout and login
```

### Wrong credentials detected

**Problem:** Setup detected wrong username/password.

**Solution:** Edit config manually:
```bash
nano /srv/docker/kdd/config/config.yaml
# Fix user/password fields
```

---

## Next Steps

✅ Setup complete!

Now create your **Backup Action** to schedule automated backups.

Continue on: [README.md](README.md)

---

## Notes

- **Config file location:** Each server stores config at `{base_path}/config/config.yaml`
- **Network detection:** Setup automatically detects which Docker network each database uses
- **Re-run setup:** You can re-run setup anytime - it won't overwrite existing entries
- **Security:** Config contains plaintext passwords - protect file permissions

---

## Example: Full Setup Session

```bash
user@server:~$ mkdir -p /srv/docker/kdd/{config,dump} && cd /srv/docker/kdd
user@server:/srv/docker/kdd$ docker run --rm -it -v /var/run/docker.sock:/var/run/docker.sock:ro -v $(pwd)/config:/config ghcr.io/kayaman78/kdd:latest /app/setup.sh --interactive

[2025-02-11 15:30:00] KDD - Database Discovery Starting
[2025-02-11 15:30:00] Mode: Interactive (will ask for each DB)
[2025-02-11 15:30:00] Docker root: /srv/docker
[2025-02-11 15:30:01] Created new config.yaml
[2025-02-11 15:30:01] Scanning Docker containers...

[2025-02-11 15:30:02] Found MySQL/MariaDB: nextcloud_db_1 (mariadb:10.11)
[2025-02-11 15:30:02]   Database: nextcloud (user: root)
  Add nextcloud_db_1 to backup config? [y/N] y
[2025-02-11 15:30:05]   Added to config: nextcloud

[2025-02-11 15:30:05] Found PostgreSQL: gitea_db_1 (postgres:16)
[2025-02-11 15:30:05]   Database: gitea (user: gitea)
  Add gitea_db_1 to backup config? [y/N] y
[2025-02-11 15:30:07]   Added to config: gitea

[2025-02-11 15:30:07] ==========================================
[2025-02-11 15:30:07] Discovery completed
[2025-02-11 15:30:07] ==========================================
[2025-02-11 15:30:07] Databases in config:
[2025-02-11 15:30:07]   MySQL/MariaDB: 1
[2025-02-11 15:30:07]   PostgreSQL: 1
[2025-02-11 15:30:07]   MongoDB: 0
[2025-02-11 15:30:07]   Total: 2
[2025-02-11 15:30:07] 
[2025-02-11 15:30:07] Config saved to: /config/config.yaml
[2025-02-11 15:30:07] 
[2025-02-11 15:30:07] Next steps:
[2025-02-11 15:30:07] 1. Review config: cat /config/config.yaml
[2025-02-11 15:30:07] 2. Test backup: /app/backup.sh
[2025-02-11 15:30:07] 3. Setup scheduled backups via Komodo Procedure

user@server:/srv/docker/kdd$ cat config/config.yaml
# Auto-generated by KDD setup.sh - 2025-02-11 15:30:00
mysql:
  - name: nextcloud
    host: nextcloud_db_1
    dbname: nextcloud
    user: root
    password: secret123
    network: mynetwork
postgres:
  - name: gitea
    host: gitea_db_1
    dbname: gitea
    user: gitea
    password: giteapass
    network: mynetwork
mongo: []

user@server:/srv/docker/kdd$ # Setup complete!
```